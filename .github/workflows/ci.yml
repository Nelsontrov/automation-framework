- name: Show files (debug)
  run: |
    pwd
    ls -la
    ls -la db.json || true

- name: Start json-server (port 3001)
  run: |
    # Use npx so we don't depend on global installs
    nohup npx -y json-server@0.17.4 --watch db.json --port 3001 --host 127.0.0.1 > json-server.log 2>&1 &
    echo "Started json-server with PID $!"
    sleep 1

- name: Wait for json-server
  run: |
    for i in {1..20}; do
      if curl -sSf http://127.0.0.1:3001 > /dev/null; then
        echo "json-server is up"
        exit 0
      fi
      echo "Waiting for json-server... ($i)"
      sleep 1
    done
    echo "json-server did not start. Log:"
    cat json-server.log || true
    exit 1

- name: Upload json-server log
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: json-server-log
    path: json-server.log
    if-no-files-found: ignore
